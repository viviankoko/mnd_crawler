name: MND PLA Crawler

on:
  # 每天定時跑（GitHub 用 UTC，這裡是 16:00 UTC ≈ 台灣 / 韓國時間 00:00）
  schedule:
    - cron: '0 16 * * *'

  # 手動觸發，順便讓你選要跑 full 還是 daily
  workflow_dispatch:
    inputs:
      mode:
        description: '執行模式：full = 全量重建；daily = 只抓新資料'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - full

  # 可選：push 到 main 也跑一次（如果你不需要可以整段刪掉）
  push:
    branches:
      - main

jobs:
  run-crawler:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pandas

      - name: Run crawler (full / daily)
        run: |
          echo "event_name = ${{ github.event_name }}"
          echo "mode input = ${{ github.event.inputs.mode }}"

          # 如果是手動觸發且選 full，就跑全量重建
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.mode }}" = "full" ]; then
            echo "▶ 手動：全量重建 (MND_MODE=full)"
            MND_MODE=full python mnd_crawler.py

          # 如果是排程，就跑 daily（只抓新資料）
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "▶ 排程：每日增量更新"
            python mnd_crawler.py

          # 其他情況（例如 push 觸發），也一律跑 daily
          else
            echo "▶ 其他觸發：預設跑每日增量更新"
            python mnd_crawler.py
          fi

      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 看看有沒有差異
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          echo "Changes detected, committing..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 主要只需要 add 資料檔，如果你還有別的自動產生檔案也可以一起加
          git add mnd_pla.csv manual_gap.csv || true

          git commit -m "Update MND PLA data [skip ci]"
          git push
